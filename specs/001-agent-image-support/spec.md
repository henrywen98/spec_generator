# Feature Specification: Agent 框架调整与图片支持

**Feature Branch**: `001-agent-image-support`
**Created**: 2026-01-13
**Status**: Draft
**Input**: User description: "我希望调整一下 Agent框架, 而且加入对图片的支持功能."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 上传图片并生成 PRD (Priority: P1)

用户希望在描述产品需求时，能够上传 UI 设计稿、流程图或其他参考图片，让系统结合图片内容生成更精准的 PRD 文档。

**Why this priority**: 图片输入是本功能的核心价值，用户上传图片后能获得更精准的 PRD 输出，直接提升产品经理的工作效率。

**Independent Test**: 可以通过上传一张 UI 设计稿图片，验证系统是否能识别图片中的界面元素并生成相关的 PRD 内容。

**Acceptance Scenarios**:

1. **Given** 用户处于首次输入界面, **When** 用户上传一张 UI 设计稿图片并输入文字描述, **Then** 系统结合图片内容和文字描述生成 PRD 文档
2. **Given** 用户已上传图片, **When** 上传完成, **Then** 系统显示图片预览，允许用户确认或删除
3. **Given** 用户上传了不支持的文件格式, **When** 上传操作执行, **Then** 系统提示用户支持的图片格式列表

---

### User Story 2 - 在对话中追加图片 (Priority: P2)

用户在与系统对话讨论 PRD 修改时，能够追加上传新的图片作为参考，以便更清晰地表达修改意图。

**Why this priority**: 在迭代讨论过程中补充视觉资料是常见需求，但优先级低于首次生成，因为首次生成是核心流程。

**Independent Test**: 在已生成 PRD 后的对话模式下，上传新图片并发送修改请求，验证系统能否理解图片内容并给出相关建议。

**Acceptance Scenarios**:

1. **Given** 用户处于 chat 模式且已有 PRD, **When** 用户上传新图片并输入修改意见, **Then** 系统结合图片和文字给出修改建议或生成新版 PRD
2. **Given** 对话中已有之前上传的图片, **When** 用户上传新图片, **Then** 新图片追加到当前对话上下文中

---

### User Story 3 - 多图片支持 (Priority: P3)

用户能够在单次请求中上传多张图片，系统综合理解所有图片内容。

**Why this priority**: 多图片是增强功能，单图片已能满足基本需求，多图片为高级用户提供更丰富的输入方式。

**Independent Test**: 上传 3 张不同的参考图片和文字描述，验证生成的 PRD 是否包含所有图片相关的内容。

**Acceptance Scenarios**:

1. **Given** 用户选择上传多张图片, **When** 上传完成, **Then** 系统显示所有图片的预览，并允许单独删除任意图片
2. **Given** 用户上传了超过数量限制的图片, **When** 尝试添加更多图片, **Then** 系统提示已达到上限并阻止添加

---

### Edge Cases

- 用户上传的图片过大时，如何处理？（限制单张图片不超过 10MB，超出时提示用户压缩或选择其他图片）
- 用户上传的图片分辨率过低无法识别时，如何处理？（系统尽力识别，输出内容质量可能下降但不报错）
- 网络中断导致图片上传失败时，如何处理？（显示上传失败提示，保留用户输入的文字内容，允许重试）
- 用户在流式输出过程中想要取消并重新上传图片时，如何处理？（复用现有的停止机制，停止后允许用户修改输入）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 支持用户在输入界面上传图片文件
- **FR-002**: 系统 MUST 支持 JPEG、PNG、GIF、WebP 格式的图片
- **FR-003**: 系统 MUST 在上传后显示图片预览
- **FR-004**: 用户 MUST 能够删除已上传但未提交的图片
- **FR-005**: 系统 MUST 将图片内容以 Base64 编码方式发送至 LLM
- **FR-006**: 系统 MUST 在 generate 模式和 chat 模式下都支持图片输入
- **FR-007**: 系统 MUST 限制单次请求最多上传 5 张图片
- **FR-008**: 系统 MUST 限制单张图片大小不超过 10MB
- **FR-009**: 系统 MUST 在图片上传失败时给出明确的错误提示
- **FR-010**: 系统 MUST 保持现有的文本流式输出功能不变
- **FR-011**: 系统 MUST 在无图片输入时保持与当前版本完全相同的行为（向后兼容）
- **FR-012**: 系统 MUST 支持图片与文字组合输入，文字描述可选（仅图片也可生成）
- **FR-013**: 系统 MUST 采用全量上下文重新生成架构——每次基于最新用户指令与完整上下文重新生成完整文稿，而非增量修改
- **FR-014**: 系统 MUST 支持纯图片输入（无文字描述），此时 AI 自动推断功能需求并在输出的"待确认/假设"章节标注推断依据

### Key Entities

- **ImageAttachment**: 用户上传的图片，包含 Base64 编码数据、文件名、MIME 类型、大小
- **MultimodalMessage**: 扩展现有消息结构，支持文本和图片内容的组合
- **GenerationContext**: 生成上下文，包含文字描述、图片列表、完整对话历史

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户上传图片后 3 秒内能看到图片预览
- **SC-002**: 包含图片的 PRD 生成请求首次响应时间不超过 5 秒
- **SC-003**: 系统支持同时处理 100 个并发的图片上传请求
- **SC-004**: 90% 以上的 UI 设计稿图片能被系统识别并生成相关 PRD 内容
  - 测试方法：准备 10 张典型 UI 设计稿图片，验证生成的 PRD 中至少包含 3 个与图片内容相关的功能描述
  - 判定标准：PRD 输出中能识别出图片中的主要 UI 元素（按钮、输入框、列表等）并转化为功能需求
- **SC-005**: 现有纯文本输入功能的响应时间无明显退化（差异不超过 10%）

## Clarifications

### Session 2026-01-13

- Q: 图片如何传递到后端 LLM？ → A: Base64 编码内嵌（图片直接编码后随请求发送）
- Q: 多模态 LLM 使用哪个模型？ → A: Qwen-VL（通义千问视觉模型，DashScope 原生支持）
- Q: Agent 框架调整的范围？ → A: 采用全量上下文重新生成架构，每次基于最新用户指令与完整上下文重新生成完整文稿，而非增量修改

### Session 2026-01-14

- Q: 竞品截图在 PRD 中如何表述？ → A: 智能判断（功能背景可提及参考来源，功能需求使用抽象化描述）
- Q: 纯图片输入（无文字）如何处理？ → A: 允许，AI 自动推断功能需求并在"待确认/假设"章节标注

## Assumptions

- 后端使用 DashScope Qwen-VL 模型处理多模态输入
- 图片采用 Base64 编码方式传输，无需额外文件存储服务
- 每次生成都基于完整上下文重新生成，保证输出一致性和完整性
- 用户主要上传的图片类型为 UI 设计稿、流程图、产品截图等与产品需求相关的视觉内容
- 图片仅用于生成时的上下文理解，不需要持久化存储
- 前端浏览器环境支持 File API 和图片预览功能
