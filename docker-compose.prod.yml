# 生产环境 Docker Compose 配置
services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: spec-generator-backend:prod
    container_name: spec-backend-prod
    restart: unless-stopped
    ports:
      - "28000:8000"
    volumes:
      # 挂载 prompts 目录（只读）
      - ./prompts:/app/prompts:ro
    environment:
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - DASHSCOPE_MODEL=${DASHSCOPE_MODEL:-qwen-max}
      - DASHSCOPE_VL_MODEL=${DASHSCOPE_VL_MODEL:-qwen-vl-plus}
      - ENABLE_THINKING=${ENABLE_THINKING:-false}
      - DEBUG_ERRORS=${DEBUG_ERRORS:-false}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:23456}
      - PROMPT_FILE_PATH=/app/prompts/prompt.md
      - PROMPT_CHAT_FILE_PATH=/app/prompts/prompt-chat.md
      # 生产环境优化
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - app-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: spec-generator-frontend:prod
    container_name: spec-frontend-prod
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      - NODE_ENV=production
      - BACKEND_URL=http://spec-backend-prod:8000
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    container_name: spec-nginx
    restart: unless-stopped
    ports:
      - "23456:23456"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /dev/null:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
